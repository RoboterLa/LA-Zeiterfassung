<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meine Aufträge heute</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --lackner-blue: #0066b3;
            --lackner-blue-dark: #005a9e;
            --lackner-gray: #6c757d;
        }
        body {
            font-family: 'Open Sans', sans-serif;
            margin: 0;
            background: #f8f9fa;
        }
        .lackner-blue {
            background: var(--lackner-blue);
        }
        .lackner-blue-text {
            color: var(--lackner-blue);
        }
        .lackner-gray {
            background: var(--lackner-gray);
        }
        .lackner-gray-text {
            color: var(--lackner-gray);
        }
        .btn-primary {
            background: var(--lackner-blue);
            color: white;
        }
        .btn-primary:hover {
            background: var(--lackner-blue-dark);
        }
        .auftrag-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .auftrag-card.done {
            background: #e6ffed;
            border: 2px solid #38a169;
            opacity: 0.7;
        }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.4); align-items: center; justify-content: center; z-index: 1000; }
        .overlay.active { display: flex; }
        .overlay-content { background: #fff; padding: 2rem; border-radius: 8px; min-width: 300px; }
        #burger-dropdown {
            z-index: 9999 !important;
            pointer-events: auto;
            min-width: 12rem;
            top: 100%;
        }
        .relative { overflow: visible !important; }
        #address-suggestions {
            position: absolute;
            left: 0;
            top: 100%;
            width: 100%;
            max-width: 300px;
            max-height: 220px;
            overflow-y: auto;
            background: #fff;
            border: 1px solid #b3b3b3;
            border-top: none;
            z-index: 2050 !important;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        }
        #address-suggestions li {
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.15s;
            border-bottom: 1px solid #f0f0f0;
        }
        #address-suggestions li:last-child { border-bottom: none; }
        #address-suggestions li:hover, #address-suggestions li.active {
            background: #e6f0ff;
            color: #0066b3;
            font-weight: bold;
        }
        .start-form-wrapper { position: relative; display: inline-block; width: 320px; z-index: 2100; }
        #map { z-index: 1; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body class="bg-gray-100 min-h-screen">
    <header class="bg-[#0066b3] shadow-lg">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="logo-container flex items-center">
                <img src="https://lackner-aufzuege-gmbh.com/wp-content/uploads/2021/09/cropped-2205_lackner_r.png" alt="Lackner Aufzüge Logo" style="height:48px;">
            </div>
            <div class="flex items-center">
                <div class="text-white text-sm mr-4 hidden md:block">
                    <span id="current-date" class="mr-2">{{ today }}</span>
                    <span id="current-time"></span>
                </div>
                <button id="burger-menu-button" class="ml-2 flex items-center text-white focus:outline-none" aria-label="Menü öffnen" tabindex="0" aria-expanded="false">
                    <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
        </div>
    </header>
    <div id="burger-dropdown" class="hidden fixed right-8 top-16 w-48 bg-white rounded-md shadow-lg py-1 z-[99999]" style="pointer-events:auto;">
        <div class="px-4 py-2 text-xs text-gray-400">Test: Menü sichtbar?</div>
        <a href="{{ url_for('dashboard') }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Dashboard</a>
        <a href="{{ url_for('zeiterfassung') }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Zeiterfassung</a>
        <a href="{{ url_for('urlaub') }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Urlaubsübersicht</a>
        <a href="{{ url_for('meine_auftraege') }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Meine Aufträge heute</a>
        <a href="{{ url_for('arbeitszeit') }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Arbeitszeit</a>
        <a href="{{ url_for('logout') }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Abmelden</a>
        <button onclick="document.getElementById('burger-dropdown').classList.add('hidden')" class="block w-full text-left px-4 py-2 text-xs text-gray-500 hover:bg-gray-100">Menü schließen</button>
    </div>
    <script>
const burgerBtn = document.getElementById('burger-menu-button');
const burgerDropdown = document.getElementById('burger-dropdown');
let burgerOpen = false;
function closeBurger() {
    burgerDropdown.classList.add('hidden');
    burgerBtn.setAttribute('aria-expanded', 'false');
    burgerOpen = false;
}
function openBurger() {
    burgerDropdown.classList.remove('hidden');
    burgerBtn.setAttribute('aria-expanded', 'true');
    burgerOpen = true;
}
burgerBtn.addEventListener('click', function(e) {
    e.stopPropagation();
    burgerOpen ? closeBurger() : openBurger();
});
burgerDropdown.addEventListener('click', function(e) {
    e.stopPropagation();
});
document.addEventListener('click', function(e) {
    if (burgerOpen && !burgerDropdown.contains(e.target) && e.target !== burgerBtn) {
        closeBurger();
    }
});
document.addEventListener('keydown', function(e) {
    if (burgerOpen && e.key === 'Escape') {
        closeBurger();
    }
});
    </script>
    <main class="flex-grow container mx-auto px-4 py-6">
        <h1 class="text-2xl font-bold lackner-blue-text mb-6">Meine Aufträge heute</h1>
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <form id="start-form" class="mb-4 flex flex-wrap gap-2 items-center">
                <label for="start-address" class="font-medium mr-2">Startadresse:</label>
                <span class="start-form-wrapper">
                    <input id="start-address" type="text" class="form-input px-3 py-2 border border-gray-300 rounded-md w-64" value="Betriebshof, München" autocomplete="off">
                    <ul id="address-suggestions" class="hidden"></ul>
                </span>
                <button type="submit" class="btn-primary px-4 py-2 rounded">Route neu berechnen</button>
            </form>
            <div id="map" class="mb-6" style="height:400px;"></div>
            <ul id="auftraege-list" class="bg-gray-50 rounded-lg divide-y divide-gray-200"></ul>
        </div>
    </main>
    <footer class="lackner-gray text-white py-4 mt-6">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>© 2025 Lackner Aufzüge GmbH - Monteur Zeiterfassungssystem</p>
        </div>
    </footer>
    <div id="overlay" class="overlay">
        <div class="overlay-content">
            <h2 class="text-lg font-bold mb-2">Auftrag zurückweisen</h2>
            <form id="reject-form">
                <input type="hidden" id="reject-id">
                <label for="reason" class="block mb-2">Begründung:</label>
                <textarea id="reason" required class="form-input w-full mb-4" rows="3" placeholder="Bitte geben Sie eine Begründung an..."></textarea>
                <div class="flex justify-end gap-2">
                    <button type="button" id="cancel-reject" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">Abbrechen</button>
                    <button type="submit" class="btn-primary px-4 py-2 rounded">Absenden</button>
                </div>
            </form>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
let auftraege = [];
let route = [];
let startCoords = [48.1351, 11.5820]; // Default: Zentrale München
let markers = [];

function fetchAuftraege(cb) {
    fetch('/api/auftraege')
        .then(r => r.json())
        .then(data => {
            auftraege = data.map(a => ({...a, id: parseInt(a.id), done: !!a.done, coords: a.coords || [0,0]}));
            route = calcOptimalRoute(startCoords, auftraege);
            cb && cb();
        });
}
function saveDoneStatus(id, done, cb) {
    fetch('/api/auftraege', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({id, done})
    }).then(() => fetchAuftraege(cb));
}
function haversine(a, b) {
    const toRad = deg => deg * Math.PI / 180;
    const R = 6371;
    const dLat = toRad(b[0] - a[0]);
    const dLon = toRad(b[1] - a[1]);
    const lat1 = toRad(a[0]);
    const lat2 = toRad(b[0]);
    const x = dLat/2, y = dLon/2;
    const h = Math.sin(x)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(y)**2;
    return 2*R*Math.asin(Math.sqrt(h));
}
function calcOptimalRoute(start, auftr) {
    let unvisited = [...auftr];
    let order = [];
    let curr = {coords: start};
    while (unvisited.length) {
        let minIdx = 0, minDist = haversine(curr.coords, unvisited[0].coords);
        for (let i=1; i<unvisited.length; ++i) {
            let d = haversine(curr.coords, unvisited[i].coords);
            if (d < minDist) { minDist = d; minIdx = i; }
        }
        order.push(unvisited[minIdx]);
        curr = unvisited[minIdx];
        unvisited.splice(minIdx,1);
    }
    return order;
}
function renderAuftraege() {
    const list = document.getElementById('auftraege-list');
    list.innerHTML = '';
    route.forEach((a, idx) => {
        const li = document.createElement('li');
        li.className = 'auftrag-card flex flex-col' + (a.done ? ' done' : '');
        li.innerHTML = `
            <div class="flex items-center gap-2">
                <input type="checkbox" class="done-checkbox" data-id="${a.id}" ${a.done ? 'checked' : ''}>
                <div class="font-bold text-lg">${idx+1}. ${a.art} <span class='text-xs text-gray-500 ml-2'>${a.uhrzeit} Uhr</span></div>
                <button class="ml-auto px-2 py-1 text-xs text-blue-700 bg-blue-100 rounded toggle-details">Details</button>
            </div>
            <div class="text-sm text-gray-600">${a.standort}</div>
            <div class="auftrag-details hidden mt-2 text-sm text-gray-700 bg-gray-50 rounded p-2">${a.details}</div>
            <div class="flex gap-2 flex-wrap mt-2">
                <a href="/zeiterfassung?auftrag=${encodeURIComponent(a.art + ' ' + a.standort)}" class="btn-primary px-3 py-1 rounded text-sm">Zeiterfassung</a>
                <button class="px-3 py-1 bg-red-500 text-white rounded text-sm reject-btn" data-id="${a.id}">Zurückweisen</button>
                <button class="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm move-up" data-idx="${idx}">↑</button>
                <button class="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm move-down" data-idx="${idx}">↓</button>
            </div>
        `;
        list.appendChild(li);
    });
}
let map = null;
function renderRoute() {
    if (!map) {
        map = L.map('map').setView([48.1374, 11.5755], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap'
        }).addTo(map);
    }
    markers.forEach(m => map.removeLayer(m));
    markers = [];
    if (window.routeLine) map.removeLayer(window.routeLine);
    let startMarker = L.marker(startCoords, {icon: L.divIcon({className:'', html:`<div style='background:#0066b3;color:#fff;border-radius:50%;width:2rem;height:2rem;display:flex;align-items:center;justify-content:center;font-weight:bold;border:2px solid #003366;'>S</div>`})}).addTo(map);
    startMarker.bindPopup('Start: ' + document.getElementById('start-address').value);
    markers.push(startMarker);
    let latlngs = [startCoords];
    route.forEach((a, idx) => {
        const marker = L.marker(a.coords, {
            icon: L.divIcon({className: a.done ? 'custom-done-marker' : '', html: `<div style='background:${a.done ? '#38a169' : '#0066b3'};color:#fff;border-radius:50%;width:2rem;height:2rem;display:flex;align-items:center;justify-content:center;font-weight:bold;border:2px solid ${a.done ? '#2f855a' : '#003366'};'>${idx+1}</div>`})
        }).addTo(map);
        marker.bindPopup(`<b>${idx+1}. ${a.art}</b><br>${a.uhrzeit} Uhr<br>${a.standort}` + (a.done ? '<br><span style=\'color:green;font-weight:bold;\'>Abgeschlossen</span>' : ''));
        marker.bindTooltip(`${idx+1}`, {permanent: true, direction: 'top', className: a.done ? 'bg-green-600 text-white font-bold' : 'bg-blue-600 text-white font-bold'});
        markers.push(marker);
        latlngs.push(a.coords);
    });
    if (latlngs.length > 1) {
        window.routeLine = L.polyline(latlngs, {color: '#0066b3', weight: 6, opacity: 0.9, smoothFactor: 1}).addTo(map);
        map.fitBounds(L.latLngBounds(latlngs), {padding: [40,40]});
    }
}
function updateRouteAndRender() {
    route = calcOptimalRoute(startCoords, auftraege);
    renderAuftraege();
    renderRoute();
}
document.addEventListener('DOMContentLoaded', function() {
    function updateDateTime() {
        const now = new Date();
        document.getElementById('current-date').textContent = now.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
        document.getElementById('current-time').textContent = now.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
    }
    updateDateTime();
    setInterval(updateDateTime, 1000);
    fetchAuftraege(updateRouteAndRender);
    document.getElementById('sort-btn')?.addEventListener('click', () => {
        route = calcOptimalRoute(startCoords, route);
        renderAuftraege();
        renderRoute();
    });
    document.getElementById('start-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const addr = document.getElementById('start-address').value;
        geocodeAddress(addr, coords => {
            startCoords = coords;
            route = calcOptimalRoute(startCoords, auftraege);
            renderAuftraege();
            renderRoute();
        });
    });
    document.getElementById('auftraege-list').addEventListener('click', function(e) {
        if (e.target.classList.contains('move-up')) {
            const idx = parseInt(e.target.dataset.idx);
            if (idx > 0) {
                [route[idx-1], route[idx]] = [route[idx], route[idx-1]];
                renderAuftraege();
                renderRoute();
            }
        } else if (e.target.classList.contains('move-down')) {
            const idx = parseInt(e.target.dataset.idx);
            if (idx < route.length-1) {
                [route[idx+1], route[idx]] = [route[idx], route[idx+1]];
                renderAuftraege();
                renderRoute();
            }
        } else if (e.target.classList.contains('reject-btn')) {
            const id = e.target.dataset.id;
            document.getElementById('reject-id').value = id;
            document.getElementById('reason').value = '';
            document.getElementById('overlay').classList.add('active');
        } else if (e.target.classList.contains('toggle-details')) {
            const details = e.target.closest('li').querySelector('.auftrag-details');
            details.classList.toggle('hidden');
        }
    });
    document.getElementById('auftraege-list').addEventListener('change', function(e) {
        if (e.target.classList.contains('done-checkbox')) {
            const id = parseInt(e.target.dataset.id);
            const checked = e.target.checked;
            saveDoneStatus(id, checked, updateRouteAndRender);
        }
    });
    document.getElementById('cancel-reject').addEventListener('click', function() {
        document.getElementById('overlay').classList.remove('active');
    });
    document.getElementById('reject-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const id = document.getElementById('reject-id').value;
        const reason = document.getElementById('reason').value.trim();
        if (!reason) return;
        // Auftrag als "abgelehnt" markieren (optional: Backend-Logik)
        auftraege = auftraege.filter(a => a.id != id);
        saveDoneStatus(id, false, updateRouteAndRender);
        document.getElementById('overlay').classList.remove('active');
        renderAuftraege();
        renderRoute();
        alert('Auftrag wurde zurückgewiesen mit Begründung: ' + reason);
    });
    document.getElementById('start-address').addEventListener('input', function() {
        showAddressSuggestions(this.value);
    });
    document.getElementById('address-suggestions').addEventListener('click', function(e) {
        if (e.target.tagName === 'LI') {
            document.getElementById('start-address').value = e.target.textContent;
            startCoords = [parseFloat(e.target.dataset.lat), parseFloat(e.target.dataset.lon)];
            document.getElementById('address-suggestions').classList.add('hidden');
            route = calcOptimalRoute(startCoords, auftraege);
            renderAuftraege();
            renderRoute();
        }
    });
    document.getElementById('address-suggestions').addEventListener('mouseover', function(e) {
        if (e.target.tagName === 'LI') {
            Array.from(this.children).forEach(li => li.classList.remove('active'));
            e.target.classList.add('active');
        }
    });
    document.getElementById('address-suggestions').addEventListener('mouseout', function(e) {
        if (e.target.tagName === 'LI') {
            e.target.classList.remove('active');
        }
    });
    document.addEventListener('click', function(e) {
        if (!document.getElementById('start-address').contains(e.target) && !document.getElementById('address-suggestions').contains(e.target)) {
            document.getElementById('address-suggestions').classList.add('hidden');
        }
        // Burger-Menü schließen, wenn außerhalb geklickt
        const burgerDropdown = document.getElementById('burger-dropdown');
        const burgerBtn = document.getElementById('burger-menu-button');
        if (burgerDropdown && !burgerDropdown.contains(e.target) && e.target !== burgerBtn) {
            burgerDropdown.classList.add('hidden');
        }
    });
    // Initiale Route optimieren
    geocodeAddress(document.getElementById('start-address').value, coords => {
        startCoords = coords;
        fetchAuftraege(updateRouteAndRender);
    });
});
function geocodeAddress(address, cb) {
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
        .then(r => r.json())
        .then(data => {
            if (data && data[0]) {
                cb([parseFloat(data[0].lat), parseFloat(data[0].lon)]);
            } else {
                alert('Adresse nicht gefunden!');
            }
        });
}
function showAddressSuggestions(query) {
    const ul = document.getElementById('address-suggestions');
    if (!query) { ul.classList.add('hidden'); ul.innerHTML = ''; return; }
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=7&extratags=1`)
        .then(r => r.json())
        .then(data => {
            ul.innerHTML = '';
            let count = 0;
            data.forEach(item => {
                if (item.lat && item.lon && item.display_name) {
                    const li = document.createElement('li');
                    li.className = 'address-suggestion';
                    li.textContent = item.display_name;
                    li.dataset.lat = item.lat;
                    li.dataset.lon = item.lon;
                    ul.appendChild(li);
                    count++;
                }
            });
            if (count === 0) {
                const li = document.createElement('li');
                li.textContent = 'Keine Adresse gefunden.';
                li.style.color = '#888';
                li.style.cursor = 'default';
                ul.appendChild(li);
            }
            ul.classList.toggle('hidden', count === 0);
        });
}
    </script>
</body>
</html> 